MKOCTFILE ?= mkoctfile -Wall
GREP ?= @GREP@

PROGS = $(patsubst %.cc,%.oct,$(wildcard *.cc))

CC_SOURCES  := $(wildcard *.cc)
CC_TST_SOURCES := $(shell $(GREP) --files-with-matches '^%!' $(CC_SOURCES))
TST_SOURCES := $(patsubst %.cc,../inst/test/%.cc-tst,$(CC_TST_SOURCES))


all: $(PROGS) $(TST_SOURCES)

%.oct: %.cc
	$(MKOCTFILE) $<

../inst/test:
	@mkdir -p "$@"

$(TST_SOURCES): ../inst/test/%.cc-tst: %.cc | ../inst/test
	@echo "Extracting tests from $< ..."
	@$(RM) -f "$@" "$@-t"
	@(      echo "## Generated from $<"; \
	        $(GREP) '^%!' "$<") > "$@"


clean:
	$(RM) -f *.o octave-core core *.oct *~

distclean: clean
	$(RM) -f config.h Makefile
