MKOCTFILE ?= mkoctfile -Wall
OCTAVE_CONFIG ?= @OCTAVE_CONFIG@
GREP ?= @GREP@

PROGS = $(patsubst %.cc,%.oct,$(wildcard *.cc))

ARCHDIR   := "$(shell $(OCTAVE_CONFIG) -p CANONICAL_HOST_TYPE)-$(shell $(OCTAVE_CONFIG) -p API_VERSION)"
CC_SOURCES  := $(wildcard *.cc)
CC_TST_SOURCES := $(shell $(GREP) --files-with-matches '^%!' $(CC_SOURCES))
TST_SOURCES := $(patsubst %.cc,../inst/$(ARCHDIR)/%.cc-tst,$(CC_TST_SOURCES))


all: $(PROGS) archtests ../inst/private/get_exeext.m

%.oct: %.cc
	$(MKOCTFILE) $<

.PHONY: archtests
archtests: $(TST_SOURCES)

../inst/$(ARCHDIR):
	@mkdir -p "$@"

../inst/private:
	@mkdir -p "$@"

../inst/$(ARCHDIR)/%.cc-tst: %.cc | ../inst/$(ARCHDIR)
	@echo "Extracting tests from $< ..."
	@$(RM) -f "$@" "$@-t"
	@(      echo "## Generated from $<"; \
	        $(GREP) '^%!' "$<") > "$@"

../inst/private/get_exeext.m: Makefile | ../inst/private
	@echo "Generating $@"
	@(echo '#auto generated private file'; \
	  echo 'function ext = get_exeext()'; \
	  echo '  ext = "@EXEEXT@";'; \
	  echo 'endfunction' ) > "$@"

clean:
	$(RM) -f *.o octave-core core *.oct *~ ../inst/private/get_exeext.m
	test -e ../inst/private && rmdir ../inst/private || true
	test -e ../inst/$(ARCHDIR) && rm -f $(TST_SOURCES) || true
	test -e ../inst/$(ARCHDIR) && rmdir ../inst/$(ARCHDIR) || true

distclean: clean
	$(RM) -f config.h Makefile config.log config.status oct-alt-includes.h
